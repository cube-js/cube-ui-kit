# Tabs Panel Caching Specification

## Overview

This document describes the intended behavior for panel caching strategies in the Tabs component.

## Two Rendering Modes

### Mode 1: Static Children (no `renderPanel`)

When using static children (`<Tab>content</Tab>`), there is **no caching logic** - React handles the content naturally.

- `keepMounted`: Simply keeps the panel DOM element mounted (hidden via `display: none`) when inactive
- `prerender`: Simply renders the panel DOM element on mount (hidden via `display: none`)
- No "caching" needed because the content is static React elements that React reconciles normally

### Mode 2: Dynamic Rendering (`renderPanel` provided)

When using `renderPanel`, caching becomes relevant because we need to decide when to call the render function.

**Core Principle:** `renderPanel` is only called when the tab is active (or once on mount for `prerender`). The caching strategies determine what happens with the cached result when the tab becomes inactive.

## Caching Strategies (only apply when `renderPanel` is provided)

### 1. `keepMounted` (boolean)

**Purpose:** Cache the `renderPanel` result after the tab has been visited, keeping it in DOM when inactive.

**Behavior:**
- When `false` (default): Panel is unmounted when tab becomes inactive, cache is cleared
- When `true`: Once a tab becomes active, call `renderPanel`, cache the result, and keep it in DOM (hidden via `display: none`) when inactive

**Key point:** `renderPanel` is only called when the tab is/becomes active. The cache is reused while inactive.

**Scope:** Can be set at Tabs level (applies to all tabs) or per-Tab level (overrides Tabs level).

### 2. `prerender` (boolean)

**Purpose:** Render the panel on mount even before the tab is visited (hidden via `display: none`).

**Without `renderPanel`:**
- When `false` (default): Panel only renders when tab becomes active
- When `true`: Panel is rendered on mount (hidden), stays in DOM

**With `renderPanel`:**
- When `false` (default): `renderPanel` is only called when tab becomes active
- When `true`: `renderPanel` is called once on mount to populate the cache. After that, the cache is reused until the tab becomes active again.

**Key point:** With `renderPanel`, `prerender` triggers ONE initial call to populate the cache. Updates only happen when the tab is active.

**Scope:** Can be set at Tabs level (applies to all tabs) or per-Tab level (overrides Tabs level).

### 3. `renderPanel` (function)

**Purpose:** Enables lazy/dynamic panel rendering via a render function instead of static children.

**Signature:** `(key: Key) => ReactNode`

**Behavior:**
- When provided, panel content is generated by calling `renderPanel(key)` instead of using children
- **Called only when the tab is active** (or once on mount if `prerender=true`)
- Without caching strategies (`keepMounted=false`, `prerender=false`): Only the active panel exists in DOM, switching tabs re-executes `renderPanel`

### 4. `panelCacheKeys` (object)

**Purpose:** Adds cache-key-based invalidation on top of `renderPanel` + caching strategies.

**Signature:** `Record<string | number, CacheKeyValue>` where `CacheKeyValue = string | number | boolean | null | undefined`

**Behavior:**
- Works only when `renderPanel` is provided
- For each panel key in `panelCacheKeys`:
  - If cache key is `undefined`: No caching for this panel, always execute fresh when active
  - If cache key is defined: Use cached content if cache key matches, otherwise re-execute when tab becomes active

## Interaction Matrix

| Scenario | When `renderPanel` is called | Cache behavior |
|----------|------------------------------|----------------|
| No caching (`keepMounted=false`, `prerender=false`) | Every time tab becomes active | No cache, unmount when inactive |
| `keepMounted=true` | First time tab becomes active, then when active AND cache invalidated | Keep in DOM when inactive |
| `prerender=true` | Once on mount, then when active AND cache invalidated | Keep in DOM always |
| `keepMounted=true` + `panelCacheKeys` | When active AND cache key changed | Keep in DOM when inactive |
| `prerender=true` + `panelCacheKeys` | Once on mount, then when active AND cache key changed | Keep in DOM always |

## Cache Invalidation with `panelCacheKeys`

When a cache key changes for a panel:

| Panel State | Cache Key Changed? | Action |
|-------------|-------------------|--------|
| Active | Yes | Re-execute `renderPanel` immediately |
| Active | No | Use cached content |
| Inactive (keepMounted/prerender) | Yes | Mark cache as stale, re-execute when tab becomes active |
| Inactive (no caching) | N/A | Will execute fresh when activated |

**Key insight:** Cache invalidation is lazy. Changing a cache key for an inactive panel does NOT trigger `renderPanel`. It only marks the cache as stale, and the update happens when the tab becomes active.

## Implementation Approach

### Cache Entry Structure

```typescript
interface CacheEntry {
  content: ReactNode;
  cacheKey: CacheKeyValue;
}
```

### Render Logic (pseudocode)

```typescript
function shouldCallRenderPanel(tabKey, isActive, cache, panelCacheKeys) {
  // No cache exists - always render to populate cache
  // (This function is only called for visible panels)
  if (!cache.has(tabKey)) {
    return true;
  }
  
  // Cache exists - only re-render if active AND cache is invalidated
  if (isActive) {
    const cached = cache.get(tabKey);
    const currentCacheKey = panelCacheKeys?.[tabKey];
    
    // panelCacheKeys entry exists - use cache-key-based invalidation
    if (currentCacheKey !== undefined) {
      return cached.cacheKey !== currentCacheKey;
    }
    
    // No panelCacheKeys entry = always fresh when active (no content caching)
    return true;
  }
  
  // Inactive with existing cache - use cache, don't re-render
  return false;
}
```

### Panel Visibility Logic

```typescript
function shouldRenderPanel(isActive, wasVisited, prerender, keepMounted) {
  // Active tab always renders
  if (isActive) return true;
  
  // Prerender keeps panel in DOM
  if (prerender) return true;
  
  // KeepMounted keeps panel if it was visited
  if (keepMounted && wasVisited) return true;
  
  return false;
}
```

## Edge Cases

1. **Tab removed:** Clean up cache entry
2. **Cache key set to `undefined`:** Disable caching for that panel, always execute fresh when active
3. **Panel not in `panelCacheKeys`:** Same as `undefined` - no caching, always fresh when active
4. **`prerender=true` switching to `false`:** Keep existing cache, just don't pre-populate new tabs
5. **Switching active tab rapidly:** Only the final active tab should have `renderPanel` called
6. **Controlled mode + keepMounted:** When a tab is clicked in controlled mode, it's marked as "visited" and rendered even if the controlled value doesn't change

## Summary

The unified caching model:

1. **`renderPanel` is called when a panel becomes visible** (first render or first visit)
2. **`keepMounted`/`prerender` control DOM persistence**
3. **`panelCacheKeys` controls content caching** - with it, content is cached; without it, active panels re-render every time
4. **Inactive panels with cache never re-render** - they use cached content
5. **Cache invalidation is lazy** - changing cache key for inactive panel only takes effect when it becomes active
